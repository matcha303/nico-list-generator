<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- === 基本設定 === -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- スマホ表示対応 -->
    <title>ニコニコ動画リスト HTMLジェネレーター</title>
    
    <!-- === ページのデザイン (CSS) === -->
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f9f9f9; }
        .header { background-color: #333; color: white; padding: 1em; text-align: center; }
        .container { max-width: 900px; margin: 2em auto; padding: 0 1em; }
        h1, h2 { border-bottom: 2px solid #ccc; padding-bottom: 8px; }
        section { margin-bottom: 2.5em; }
        textarea { width: 100%; height: 150px; font-size: 14px; margin-bottom: 10px; font-family: monospace; box-sizing: border-box; }
        button { font-size: 16px; padding: 10px 20px; cursor: pointer; border: none; background-color: #007bff; color: white; border-radius: 5px; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #output-container { margin-top: 20px; }
        #preview-area { border: 1px solid #ccc; padding: 10px; margin-top: 10px; background-color: #f0f0f0; overflow-x: auto; }
        #status-message, #mylist-status { margin-top: 10px; font-weight: bold; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-group input[type="text"] { flex-grow: 1; font-size: 14px; padding: 5px; }
        .input-group button { font-size: 14px; padding: 5px 15px; flex-shrink: 0; background-color: #6c757d; }
        .input-group button:hover { background-color: #5a6268; }
        .settings-group { display: flex; gap: 1.5em; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .settings-group label { font-weight: bold; }
        .button-group { display: flex; gap: 10px; margin-top: -5px; margin-bottom: 10px; }
        .button-group button { font-size: 14px; padding: 5px 15px; background-color: #e0e0e0; color: #333; border: 1px solid #ccc; }
        .button-group button:hover { background-color: #d4d4d4; }
        .output-actions { margin-top: 10px; }
        .output-actions button { background-color: #28a745; }
        .output-actions button:hover { background-color: #218838; }
        .footer { text-align: center; margin-top: 3em; padding: 1em; color: #777; font-size: 0.9em; border-top: 1px solid #eee; }
        .disclaimer { font-size: 0.8em; color: #999; }
    </style>
</head>
<body>

    <!-- === ヘッダー部分 === -->
    <header class="header">
        <h1>ニコニコ動画リスト HTMLジェネレーター</h1>
    </header>

    <div class="container">
        <!-- === 使い方説明セクション === -->
        <section>
            <h2>ツールの使い方</h2>
            <ol>
                <li><b>データ入力:</b> マイリストURLから読み込むか、手動で「動画URL,タイトル」の形式で入力します。</li>
                <li><b>デザイン設定:</b> 表の列数、タイトルの背景色と文字色を設定します。</li>
                <li><b>HTMLを生成:</b> ボタンを押すと、プレビューとHTMLコードが出力されます。</li>
            </ol>
        </section>
        
        <!-- === データ入力セクション === -->
        <section>
            <h2>1. データの入力</h2>
            <p><b>マイリストから自動読み込み (公開マイリストのみ)</b></p>
            <div class="input-group">
                <input type="text" id="mylist-url" placeholder="マイリストのURLをここに貼り付け">
                <button id="fetch-mylist-btn">読み込む</button>
            </div>
            <div id="mylist-status"></div>
            <p><b>手動で入力</b></p>
            <textarea id="input-data" placeholder="例: https://www.nicovideo.jp/watch/sm1715919,メルト"></textarea>
            <div class="button-group">
                 <button id="reverse-btn">入力順を反転</button>
            </div>
        </section>

        <!-- === デザイン設定セクション === -->
        <section>
            <h2>2. デザイン設定</h2>
            <div class="settings-group">
                <div>
                    <label for="columns-input">表の列数:</label>
                    <input type="number" id="columns-input" value="4" min="1" max="10" style="width: 50px;">
                </div>
                <div>
                    <label for="title-bg-color">タイトル背景色:</label>
                    <input type="color" id="title-bg-color" value="#808080">
                </div>
                <div>
                    <label for="title-text-color">タイトル文字色:</label>
                    <input type="color" id="title-text-color" value="#ffffff">
                </div>
            </div>
        </section>
        
        <!-- === 生成実行ボタン === -->
        <button id="generate-btn">HTMLを生成</button>
        <div id="status-message"></div>

        <!-- === 出力結果セクション (最初は非表示) === -->
        <div id="output-container" style="display:none;">
            <h2>3. プレビュー</h2>
            <div id="preview-area"></div>
            <h2>4. HTMLコードの出力</h2>
            <p>以下のコードをコピーして使用してください。</p>
            <textarea id="output-html" readonly></textarea>
            <div class="output-actions">
                <button id="copy-btn">コードをコピー</button>
            </div>
        </div>
    </div>
    
    <!-- === フッター部分 === -->
    <footer class="footer">
        <p>このツールは非公式です。</p>
        <p class="disclaimer">
            本ツールの利用により生じた、いかなる損害についても作成者は責任を負いません。<br>
            APIの仕様変更などにより、予告なく利用できなくなる場合があります。
        </p>
    </footer>

    <!-- ====================================================== -->
    <!-- === JavaScriptによるプログラム本体 ===================== -->
    <!-- ====================================================== -->
    <script>
        // --- ここからプログラム ---

        // === 1. HTML要素の取得 ===
        // ---------------------------------
        // プログラムで操作したいHTML部品に名前(ID)を付けて、いつでも使えるように変数に格納しておく
        
        // --- 入力関連 ---
        const inputData = document.getElementById('input-data');
        const mylistUrlInput = document.getElementById('mylist-url');
        
        // --- 設定関連 ---
        const columnsInput = document.getElementById('columns-input');
        const titleBgColorInput = document.getElementById('title-bg-color');
        const titleTextColorInput = document.getElementById('title-text-color');
        
        // --- ボタン関連 ---
        const fetchMylistBtn = document.getElementById('fetch-mylist-btn');
        const reverseBtn = document.getElementById('reverse-btn');
        const generateBtn = document.getElementById('generate-btn');
        const copyBtn = document.getElementById('copy-btn');

        // --- 出力・表示関連 ---
        const outputContainer = document.getElementById('output-container');
        const previewArea = document.getElementById('preview-area');
        const outputHtml = document.getElementById('output-html');
        const mylistStatus = document.getElementById('mylist-status');
        const statusMessage = document.getElementById('status-message');


        // === 2. イベントリスナーの設定 ===
        // ---------------------------------
        // どのボタンがクリックされたら、どの処理(関数)を呼び出すかを割り当てる
        fetchMylistBtn.addEventListener('click', handleFetchMylist);
        reverseBtn.addEventListener('click', handleReverse);
        generateBtn.addEventListener('click', handleGenerate);
        copyBtn.addEventListener('click', handleCopy);


        // === 3. 各機能の処理 (関数) ===
        // ---------------------------------

        /**
         * クリップボードにテキストをコピーする関数
         */
        async function handleCopy() {
            const textToCopy = outputHtml.value;
            if (!textToCopy) return;

            try {
                await navigator.clipboard.writeText(textToCopy);
                copyBtn.textContent = 'コピーしました！';
                setTimeout(() => { copyBtn.textContent = 'コードをコピー'; }, 2000);
            } catch (err) {
                console.error('クリップボードへのコピーに失敗しました:', err);
                alert('コピーに失敗しました。');
            }
        }

        /**
         * テキストエリアの入力順を反転させる関数
         */
        function handleReverse() {
            const currentData = inputData.value;
            const reversedData = currentData.trim().split('\n').reverse().join('\n');
            inputData.value = reversedData;
        }
        
        /**
         * マイリストURLから動画情報を読み込む関数
         */
        async function handleFetchMylist() {
            const mylistUrl = mylistUrlInput.value.trim();
            const match = mylistUrl.match(/mylist\/(\d+)/);
            if (!match || !match[1]) {
                mylistStatus.textContent = "エラー: 有効なマイリストURLを入力してください。";
                mylistStatus.style.color = 'red';
                return;
            }
            const mylistId = match[1];
            mylistStatus.textContent = "マイリストを読み込み中...";
            mylistStatus.style.color = 'black';
            try {
                const rssUrl = `https://www.nicovideo.jp/mylist/${mylistId}?rss=2.0`;
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(rssUrl)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("マイリスト情報の取得に失敗しました。");
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                const items = xmlDoc.querySelectorAll('item');
                if (items.length === 0) throw new Error("動画が見つかりませんでした。マイリストが空か非公開の可能性があります。");
                const videoData = Array.from(items).map(item => `${item.querySelector('link').textContent},${item.querySelector('title').textContent}`).join('\n');
                inputData.value = videoData;
                mylistStatus.textContent = `✅ ${items.length}件の動画を読み込みました。必要に応じてタイトルや順番を編集し、「HTMLを生成」ボタンを押してください。`;
                mylistStatus.style.color = 'green';
            } catch (error) {
                mylistStatus.textContent = `エラー: ${error.message}`;
                mylistStatus.style.color = 'red';
                console.error(error);
            }
        }

        /**
         * 動画URLから動画ID(smXXXXなど)を抽出する関数
         */
        function extractVideoId(url) {
            const match = url.match(/(sm|so|nm)\d+/);
            return match ? match[0] : null;
        }

        /**
         * 動画IDからサムネイルURLを取得する関数
         */
        async function fetchVideoInfo(videoId) {
            const originalApiUrl = `https://ext.nicovideo.jp/api/getthumbinfo/${videoId}`;
            const apiUrl = `https://corsproxy.io/?${encodeURIComponent(originalApiUrl)}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('API response failed');
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                if (xmlDoc.querySelector('nicovideo_thumb_response').getAttribute('status') === 'fail') {
                    throw new Error('API returned failure status');
                }
                const thumbnailUrl = xmlDoc.querySelector('thumb thumbnail_url').textContent;
                return { thumbnailUrl };
            } catch (error) {
                console.error(`[${videoId}] の情報取得に失敗:`, error);
                return { error: true };
            }
        }

        /**
         * メイン処理: HTMLを生成する関数
         */
        async function handleGenerate() {
            statusMessage.textContent = '情報を取得中...';
            outputContainer.style.display = 'none';
            const columnsPerRow = parseInt(columnsInput.value, 10);
            const titleBgColor = titleBgColorInput.value;
            const titleTextColor = titleTextColorInput.value;
            const lines = inputData.value.trim().split('\n');
            if (lines.length === 0 || lines[0] === '' || columnsPerRow < 1) {
                statusMessage.textContent = 'データが入力されていないか、列数が無効です。';
                return;
            }
            const songList = [];
            for (const line of lines) {
                if (!line.includes(',')) continue;
                const [url, title] = line.split(/,(.+)/);
                const videoId = extractVideoId(url.trim());
                if (videoId) {
                    songList.push({ id: videoId, title: title.trim(), videoUrl: `https://www.nicovideo.jp/watch/${videoId}`, pediaUrl: `https://dic.nicovideo.jp/v/${videoId}` });
                }
            }
            const detailedSongList = await Promise.all(songList.map(async (song) => ({ ...song, ...(await fetchVideoInfo(song.id)) })));

            let tableHtml = '<table style="text-align: center; margin: auto auto 30px; width: 100%; table-layout: fixed; font-size: small;">\n<tbody>\n';
            let rowCounter = 1;

            for (let i = 0; i < detailedSongList.length; i += columnsPerRow) {
                const rowSongs = detailedSongList.slice(i, i + columnsPerRow);
                tableHtml += `<!-- ${rowCounter}行目 -->\n`;
                
                // --- タイトル行(th)を生成 ---
                let titleRowHtml = '<tr>\n';
                rowSongs.forEach(song => {
                    titleRowHtml += `\t<th style="border: 1px solid #ffffff; background-color: ${titleBgColor}; vertical-align: middle;">\n\t\t<a style="color: ${titleTextColor};" href="${song.pediaUrl}">${song.title}</a>\n\t</th>\n`;
                });
                // 空白セルを埋める
                for (let j = rowSongs.length; j < columnsPerRow; j++) {
                    titleRowHtml += `\t<th style="border: 1px solid #ffffff; background-color: ${titleBgColor}; vertical-align: middle;">\n\t</th>\n`;
                }
                titleRowHtml += '</tr>\n';

                // --- サムネイル行(td)を生成 ---
                let imageRowHtml = '<tr>\n';
                rowSongs.forEach(song => {
                    imageRowHtml += '\t<td style="border: solid 1px #ffffff; border-top: none; background-color: #000000; vertical-align: middle;">\n';
                    if (song.error) {
                        imageRowHtml += '\t\t<span style="color: red;">読込失敗</span>\n';
                    } else {
                        imageRowHtml += `\t\t<a style="background-image: none;" href="${song.videoUrl}" target="_blank"><img alt="${song.title}" src="${song.thumbnailUrl}"></a>\n`;
                    }
                    imageRowHtml += '\t</td>\n';
                });
                // 空白セルを埋める
                for (let j = rowSongs.length; j < columnsPerRow; j++) {
                    imageRowHtml += '\t<td style="border: solid 1px #ffffff; border-top: none; background-color: #000000; vertical-align: middle;">\n\t</td>\n';
                }
                imageRowHtml += '</tr>\n';

                tableHtml += titleRowHtml + imageRowHtml;
                rowCounter++;
            }
            tableHtml += '</tbody>\n</table>';
            outputHtml.value = tableHtml;
            previewArea.innerHTML = tableHtml;
            outputContainer.style.display = 'block';
            statusMessage.textContent = '生成が完了しました！';
        }

    </script>
</body>
</html>